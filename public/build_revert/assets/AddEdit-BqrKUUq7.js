import{a as O}from"./apiAdmin-yFrp6bZq.js";import{U as H}from"./UserInfo-4wSQ2hbz.js";import{Y as Q,b as Y,r as h,y as Z,_ as R,d as N,z as L,ak as B,a6 as j,o as y,g as I,w as a,a as t,h as T,c as M,D as V,j as C,t as b,i as P,aM as J,a_ as K,aL as X,aN as x,bg as ee,G as ae,q as z,f as W,Q as te,aT as ne,L as q,p as U,aD as oe,m as se,I as le,b3 as ue,v as de,bh as me,F as re,B as ie,a0 as pe,ap as _e,aG as ce}from"./app-OikDM5Kw.js";import{P as ye}from"./AddButton-SD-wiXX7.js";import{D as fe}from"./DateTimePicker-CSM27X8x.js";import{S as ve}from"./SaveOutlined-BSR-wlKo.js";const ge=()=>{const{t:e}=Q(),n=Z(),A=["payment_mode_id","user_id"],{dayjs:F}=Y(),w=h(n.meta.paymentType),k=h(n.meta.menuParent),v=h(`payment-${w.value}`),D=h({payment_type:w.value,date:F().format("YYYY-MM-DD"),amount:"",payment_mode_id:void 0,user_id:void 0,notes:""}),g=[{title:e("payments.date"),dataIndex:"date",sorter:!0},{title:e("payments.transaction_number"),dataIndex:"payment_number",sorter:!0},{title:e("payments.user"),dataIndex:"user_id",sorter:!0},{title:e("payments.amount"),dataIndex:"amount",sorter:!0},{title:e("common.action"),dataIndex:"action"}],l=[{key:"payment_number",value:e("payments.transaction_number")}],d=[{title:e("stock.invoice_number"),dataIndex:"invoice_number"},{title:e("common.date"),dataIndex:"date"},{title:e("payments.invoice_amount"),dataIndex:"amount"},{title:e("common.action"),dataIndex:"action"}];return{addEditUrl:v,initData:D,columns:g,filterableColumns:l,hashableColumns:A,settleInvoiceColumns:d,paymentType:w,menuParent:k}},be=N({props:["userId","amount"],setup(e,{emit:n}){const{settleInvoiceColumns:A,paymentType:F}=ge(),{addEditRequestAdmin:w,loading:k,rules:v}=O(),{formatDate:D,disabledDate:g,appSetting:l,formatAmountCurrency:d}=Y(),p=h([]),S=h(0),f=h(0);L(()=>{_()});const i=()=>{w({url:e.url,data:e.formData,successMessage:e.successMessage,success:o=>{n("addEditSuccess",o.xid)}})},_=()=>{axiosAdmin.post("user-invoices",{user_id:e.userId,payment_type:F.value}).then(o=>{const u=o.data.invoices;var m=e.amount,r=0;B(u,c=>{c.due_amount<=m?(c.paying_amount=c.due_amount,m=parseFloat(m)-parseFloat(c.due_amount),r=parseFloat(r)+parseFloat(c.due_amount)):c.due_amount>m&&(c.paying_amount=m,r=parseFloat(r)+parseFloat(m),m=0)}),S.value=r,f.value=parseFloat(e.amount)-parseFloat(r),p.value=u})},$=o=>{const u=p.value;var m=0;B(u,c=>{m+=parseFloat(c.paying_amount)}),o.paying_amount>o.due_amount?o.paying_amount=o.due_amount:m>e.amount&&(o.paying_amount=parseFloat(e.amount)-(m-parseFloat(o.paying_amount))),o.paying_amount||(o.paying_amount=0);var r=0;B(u,c=>{r+=parseFloat(c.paying_amount)}),S.value=r,f.value=parseFloat(e.amount)-parseFloat(r)},E=()=>{v.value={},n("closed")};return j(e,(o,u)=>{_()}),{loading:k,rules:v,onClose:E,onSubmit:i,invoices:p,settleInvoiceColumns:A,setteledAmount:S,unUsedAmount:f,inputValueChanged:$,appSetting:l,formatDate:D,disabledDate:g,formatAmountCurrency:d}}}),he={class:"table-responsive"};function we(e,n,A,F,w,k){const v=J,D=K,g=X,l=x,d=ee,p=ae,S=z,f=W;return y(),I(f,null,{default:a(()=>[t(S,{span:24},{default:a(()=>[T("div",he,[t(p,{columns:e.settleInvoiceColumns,"row-key":i=>i.xid,"data-source":e.invoices,pagination:!1},{bodyCell:a(({column:i,record:_})=>[i.dataIndex==="date"?(y(),M(V,{key:0},[C(b(e.formatDate(_.order_date)),1)],64)):P("",!0),i.dataIndex==="amount"?(y(),M(V,{key:1},[C(b(e.formatAmountCurrency(_.total))+" ",1),n[0]||(n[0]=T("br",null,null,-1)),T("small",null,[t(v,{type:"danger"},{default:a(()=>[C(" ("+b(e.$t("common.pending"))+": "+b(e.formatAmountCurrency(_.due_amount))+") ",1)]),_:2},1024)])],64)):P("",!0),i.dataIndex==="action"?(y(),I(D,{key:2,addonBefore:e.appSetting.currency.symbol,value:_.paying_amount,"onUpdate:value":$=>_.paying_amount=$,placeholder:"0",min:0,onBlur:$=>e.inputValueChanged(_)},null,8,["addonBefore","value","onUpdate:value","onBlur"])):P("",!0)]),summary:a(()=>[t(d,{fixed:""},{default:a(()=>[t(l,null,{default:a(()=>[t(g,{"col-span":3},{default:a(()=>[t(v,{strong:""},{default:a(()=>[C(b(e.$t("payments.unused_amount"))+" : ",1)]),_:1}),C(" "+b(e.formatAmountCurrency(e.unUsedAmount?e.unUsedAmount:0)),1)]),_:1}),t(g,{"col-span":2},{default:a(()=>[C(b(e.formatAmountCurrency(e.setteledAmount?e.setteledAmount:0)),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["columns","row-key","data-source"]),n[1]||(n[1]=T("br",null,null,-1))])]),_:1})]),_:1})}const De=R(be,[["render",we]]),Se=N({props:["formData","data","visible","url","addEditType","pageTitle","successMessage"],components:{PlusOutlined:te,LoadingOutlined:ne,SaveOutlined:ve,UserInfo:H,PaymentModeAddButton:ye,SettleInvoices:De,DateTimePicker:fe},setup(e,{emit:n}){const{addEditRequestAdmin:A,loading:F,rules:w}=O(),{disabledDate:k,appSetting:v,formatAmountCurrency:D,dayjs:g}=Y(),l=h([]),d=h([]),p="customer-suppliers",S="payment-modes?limit=10000",f=h(null),i=h({});L(()=>{const o=axiosAdmin.post(p),u=axiosAdmin.get(S);Promise.all([o,u]).then(([m,r])=>{d.value=m.data,l.value=r.data})});const _=()=>{const o=[];e.addEditType=="add"&&f.value&&f.value.invoices&&B(f.value.invoices,u=>{o.push({order_id:u.xid,amount:u.paying_amount})}),A({url:e.url,data:{...i.value,invoices:o},successMessage:e.successMessage,success:u=>{n("addEditSuccess",u.xid)}})},$=()=>{axiosAdmin.get("payment-modes?limit=10000").then(o=>{l.value=o.data})},E=()=>{w.value={},n("closed")};return j(()=>e.visible,(o,u)=>{o&&(e.addEditType=="add"?i.value={...e.formData,date:g().utc().format("YYYY-MM-DDTHH:mm:ssZ")}:i.value={...e.formData})}),{loading:F,rules:w,onClose:E,onSubmit:_,users:d,paymentModes:l,paymentModeAdded:$,settleInvoiceRef:f,appSetting:v,disabledDate:k,formatAmountCurrency:D,drawerWidth:window.innerWidth<=991?"90%":"45%",newFormData:i}}}),Ce={style:{display:"flex"}},$e={key:1},Ae={key:2};function Fe(e,n,A,F,w,k){const v=U("UserInfo"),D=ce,g=oe,l=se,d=z,p=W,S=le,f=U("DateTimePicker"),i=U("PaymentModeAddButton"),_=ue,$=de,E=me,o=U("SettleInvoices"),u=re,m=U("SaveOutlined"),r=ie,c=pe,G=_e;return y(),I(G,{title:e.pageTitle,width:e.drawerWidth,open:e.visible,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},maskClosable:!1,onClose:e.onClose},{footer:a(()=>[t(c,null,{default:a(()=>[t(r,{key:"submit",type:"primary",loading:e.loading,onClick:e.onSubmit},{icon:a(()=>[t(m)]),default:a(()=>[C(" "+b(e.addEditType=="add"?e.$t("common.create"):e.$t("common.update")),1)]),_:1},8,["loading","onClick"]),t(r,{key:"back",onClick:e.onClose},{default:a(()=>[C(b(e.$t("common.cancel")),1)]),_:1},8,["onClick"])]),_:1})]),default:a(()=>[t(u,{layout:"vertical"},{default:a(()=>[t(p,{gutter:16},{default:a(()=>[t(d,{xs:24,sm:24,md:24,lg:24},{default:a(()=>[t(l,{label:e.$t("payments.user"),name:"user_id",help:e.rules.user_id?e.rules.user_id.message:null,validateStatus:e.rules.user_id?"error":null,class:"required"},{default:a(()=>[t(g,{value:e.newFormData.user_id,"onUpdate:value":n[0]||(n[0]=s=>e.newFormData.user_id=s),placeholder:e.$t("common.select_default_text",[e.$t("payments.user")]),allowClear:!0,"option-label-prop":"label",optionFilterProp:"label","show-search":""},{default:a(()=>[(y(!0),M(V,null,q(e.users,s=>(y(),I(D,{key:s.xid,value:s.xid,label:s.name},{default:a(()=>[t(v,{user:s,size:"small"},null,8,["user"])]),_:2},1032,["value","label"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label","help","validateStatus"])]),_:1})]),_:1}),e.addEditType=="add"?(y(),I(p,{key:0,gutter:16},{default:a(()=>[t(d,{xs:24,sm:24,md:24,lg:24},{default:a(()=>[t(l,{label:e.$t("payments.amount"),name:"amount",help:e.rules.amount?e.rules.amount.message:null,validateStatus:e.rules.amount?"error":null,class:"required"},{default:a(()=>[t(S,{prefix:e.appSetting.currency.symbol,value:e.newFormData.amount,"onUpdate:value":n[1]||(n[1]=s=>e.newFormData.amount=s),placeholder:e.$t("common.placeholder_default_text",[e.$t("payments.amount")])},null,8,["prefix","value","placeholder"])]),_:1},8,["label","help","validateStatus"])]),_:1})]),_:1})):P("",!0),t(p,{gutter:16},{default:a(()=>[t(d,{xs:24,sm:24,md:12,lg:12},{default:a(()=>[t(l,{label:e.$t("payments.date"),name:"date",help:e.rules.date?e.rules.date.message:null,validateStatus:e.rules.date?"error":null,class:"required"},{default:a(()=>[t(f,{dateTime:e.newFormData.date,onDateTimeChanged:n[2]||(n[2]=s=>e.newFormData.date=s)},null,8,["dateTime"])]),_:1},8,["label","help","validateStatus"])]),_:1}),t(d,{xs:24,sm:24,md:12,lg:12},{default:a(()=>[t(l,{label:e.$t("payments.payment_mode"),name:"payment_mode_id",help:e.rules.payment_mode_id?e.rules.payment_mode_id.message:null,validateStatus:e.rules.payment_mode_id?"error":null,class:"required"},{default:a(()=>[T("span",Ce,[t(g,{value:e.newFormData.payment_mode_id,"onUpdate:value":n[3]||(n[3]=s=>e.newFormData.payment_mode_id=s),placeholder:e.$t("common.select_default_text",[e.$t("payments.payment_mode")]),allowClear:!0},{default:a(()=>[(y(!0),M(V,null,q(e.paymentModes,s=>(y(),I(D,{key:s.xid,value:s.xid},{default:a(()=>[C(b(s.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"]),t(i,{onOnAddSuccess:e.paymentModeAdded},null,8,["onOnAddSuccess"])])]),_:1},8,["label","help","validateStatus"])]),_:1})]),_:1}),t(p,{gutter:16},{default:a(()=>[t(d,{xs:24,sm:24,md:24,lg:24},{default:a(()=>[t(l,{label:e.$t("payments.notes"),name:"notes",help:e.rules.notes?e.rules.notes.message:null,validateStatus:e.rules.notes?"error":null},{default:a(()=>[t(_,{value:e.newFormData.notes,"onUpdate:value":n[4]||(n[4]=s=>e.newFormData.notes=s),placeholder:e.$t("common.placeholder_default_text",[e.$t("payments.notes")]),"auto-size":{minRows:2,maxRows:3}},null,8,["value","placeholder"])]),_:1},8,["label","help","validateStatus"])]),_:1})]),_:1}),t($,{class:"mt-0"}),e.addEditType=="add"?(y(),M("div",$e,[t(p,{gutter:16},{default:a(()=>[t(d,{xs:24,sm:24,md:24,lg:24},{default:a(()=>[t(l,null,{default:a(()=>[t(E,{type:"warning",strong:""},{default:a(()=>[T("blockquote",null,b(e.$t("payments.settle_invoice_using_payment")),1)]),_:1})]),_:1})]),_:1})]),_:1}),e.newFormData.user_id?(y(),I(o,{key:0,ref:"settleInvoiceRef",userId:e.newFormData.user_id,amount:e.newFormData.amount},null,8,["userId","amount"])):P("",!0)])):(y(),M("div",Ae))]),_:1})]),_:1},8,["title","width","open","onClose"])}const Pe=R(Se,[["render",Fe]]);export{Pe as A,ge as f};
