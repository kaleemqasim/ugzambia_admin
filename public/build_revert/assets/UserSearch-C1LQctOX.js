import{b as te,Y as ae,r as p,e as M,aW as H,b5 as ne,aZ as se,b6 as oe,y as ue,b4 as ie,_ as le,d as re,aV as de,a6 as ce,aX as pe,o as S,g as V,w as C,h as Y,a as j,ab as _e,c as U,L as me,D as ve,p as q,aY as fe,aD as he,m as xe,j as L,t as N,i as ye,aG as be}from"./app-OikDM5Kw.js";import{S as ge}from"./SupplierAddButton-DQm7fLpn.js";import{C as Se}from"./CustomerAddButton-DTZPshvj.js";const De=()=>{const{formatAmount:a,orderType:v,orderPageObject:i,selectedWarehouse:A,dayjs:k,appSetting:c}=te(),{t:h}=ae(),g=ue(),o=p([]),f=p([]),F=p([]),l=M({orderSearchTerm:void 0,productFetching:!1,products:[]}),r=p({order_type:g.params.type,invoice_number:"",order_date:k().utc().format("YYYY-MM-DDTHH:mm:ssZ"),warehouse_id:v.value=="stock-transfers"?void 0:A.value.xid,user_id:void 0,terms_condition:A.value.terms_condition,notes:"",order_status:void 0,tax_id:void 0,tax_rate:0,tax_amount:0,discount:0,shipping:0,subtotal:0}),d=p([]),w=p({subtotal:0,tax:0}),D=p(!1),K=p(!1),_=p({}),Q=p([]),B=p(""),W=H(e=>{I(e)},300),I=e=>{l.products=[],e!=""&&(l.productFetching=!0,axiosAdmin.post("search-product",{order_type:i.value.type,search_term:e,warehouse_id:r.value.warehouse_id}).then(t=>{t.data.length==1?P("",{product:t.data[0]}):l.products=t.data,l.productFetching=!1}))},Z=e=>{ie(()=>{e.keyCode==13&&I(e.target.value)})},P=(e,n)=>{const t=n.product;if(ne(f.value,t.xid)){const m=se(o.value,["xid",t.xid]);if(m&&m.quantity<m.stock_quantity){const x=[];var s={};o.value.map(y=>{var b=y.quantity;y.xid==t.xid&&(b+=1,y.quantity=b,s=y),x.push(y)}),o.value=x;var u=new Audio(c.value.beep_audio_url);u.play(),l.orderSearchTerm=void 0,l.products=[],$(s)}else l.orderSearchTerm=void 0,l.products=[],oe.error(h("common.out_of_stock"))}else{f.value.push(t.xid),o.value.push({...t,sn:o.value.length+1,unit_price:a(t.unit_price),tax_amount:a(t.tax_amount),subtotal:a(t.subtotal)}),l.orderSearchTerm=void 0,l.products=[],T();var u=new Audio(c.value.beep_audio_url);u.play()}},R=e=>{var n=parseFloat(e.quantity),t=parseFloat(e.stock_quantity);e.item_id;const u=parseFloat(e.unit_price);e.product_type!="service"&&(n=n>t&&(i.value.type=="sales"||i.value.type=="purchase-returns")?t:n);const s=e.discount_rate,m=s>0?s/100*u:0,x=u-m;var O=0,y=x,b=u;return e.tax_rate>0&&(e.tax_type=="inclusive"?(b=x*100/(100+e.tax_rate),O=b*(e.tax_rate/100)):(O=x*(e.tax_rate/100),y=x+O,b=x)),{...e,total_discount:m*n,subtotal:y*n,quantity:n,total_tax:O*n,max_quantity:t,single_unit_price:b}},$=e=>{const n=[];o.value.map(t=>{if(t.xid==e.xid){const u=R(e);n.push(u)}else n.push(t)}),o.value=n,T()},T=()=>{let e=0,n=0;o.value.map(m=>{e+=m.subtotal});const t=r.value.discount!=""?parseFloat(r.value.discount):0,u=r.value.tax_rate!=""?parseFloat(r.value.tax_rate):0;o.value.map(m=>{n+=m.total_tax}),w.value.subtotal=e,w.value.tax=n,e=e-t;const s=e*(u/100);e=e+parseFloat(r.value.shipping),r.value.subtotal=a(e+s),r.value.tax_amount=a(s),r.value.discount=t},z=()=>{let e=0,n=0;o.value.map(t=>{e+=t.subtotal}),o.value.map(t=>{n+=t.total_tax}),w.value.subtotal=e,w.value.tax=n},G=e=>{const n=[];let t=1;o.value.map(s=>{e.item_id&&e.item_id!=""&&e.item_id!=null&&e.item_id==s.item_id&&s.item_id!=null&&(F.value=[...F.value,s.item_id]),s.xid!=e.xid&&(n.push({...s,sn:t,single_unit_price:a(s.single_unit_price),tax_amount:a(s.tax_amount),subtotal:a(s.subtotal)}),t++)}),o.value=n;const u=f.value.filter(s=>s!=e.xid);f.value=u,T()},X=(e,n)=>{r.value.tax_rate=e==null?0:n.tax.rate,T()},J=e=>{_.value={id:e.xid,discount_rate:e.discount_rate,unit_price:e.unit_price,tax_id:e.x_tax_id,tax_type:e.tax_type==null?void 0:e.tax_type},D.value=!0,B.value=e.name},ee=()=>{const e=o.value.filter(s=>s.xid==_.value.id),n=d.value.filter(s=>s.xid==_.value.tax_id),t=_.value.tax_type!=null?_.value.tax_type:"exclusive",u={...e[0],discount_rate:parseFloat(_.value.discount_rate),unit_price:parseFloat(_.value.unit_price),tax_id:_.value.tax_id,tax_rate:n[0]?n[0].rate:0,tax_type:t};$(u),E()},E=()=>{_.value={},D.value=!1};return{state:l,route:g,orderType:v,orderPageObject:i,selectedProducts:o,selectedProductIds:f,formData:r,productsAmount:w,taxes:d,fetchProducts:W,searchValueSelected:P,recalculateValues:R,quantityChanged:$,recalculateFinalTotal:T,showDeleteConfirm:G,taxChanged:X,editItem:J,addEditVisible:D,addEditFormData:_,addEditFormSubmitting:K,addEditRules:Q,addEditPageTitle:B,onAddEditSubmit:ee,onAddEditClose:E,removedOrderItemsIds:F,calculateProductAmount:z,inputValueChanged:Z}},Ae=re({props:["orderPageObject","rules","usersList","editOrderDisable"],emits:["onSuccess"],components:{SearchOutlined:de,SupplierAddButton:ge,CustomerAddButton:Se},setup(a,{emit:v}){const i=M({orderSearchTerm:[],productFetching:!1,products:[]}),A=H(c=>{if(i.products=[],c!=""){const h=c.trim();i.productFetching=!0;const g=`name lk "${h}%" or (phone lk "${h}%")`;let o=`${a.orderPageObject.userType}?fields=id,xid,name,phone&filters=${encodeURIComponent(g)}`;axiosAdmin.get(o).then(f=>{i.products=f.data,i.productFetching=!1})}},300),k=(c,h)=>{v("onSuccess",c)};return ce(()=>a.usersList,(c,h)=>{i.products=[c],i.orderSearchTerm=c.xid}),{...pe(i),fetchProducts:A,searchValueSelected:k}}}),Fe={style:{display:"flex"}},we={key:0};function Te(a,v,i,A,k,c){const h=q("SearchOutlined"),g=fe,o=be,f=he,F=q("SupplierAddButton"),l=q("CustomerAddButton"),r=xe;return S(),V(r,{label:a.$t(`${a.orderPageObject.langKey}.user`),name:"user_id",help:a.rules.user_id?a.rules.user_id.message:null,validateStatus:a.rules.user_id?"error":null,class:"required"},{default:C(()=>[Y("span",Fe,[j(f,{value:a.orderSearchTerm,"onUpdate:value":v[0]||(v[0]=d=>a.orderSearchTerm=d),"show-search":"","filter-option":!1,placeholder:a.$t("common.select_default_text",[a.$t(`${a.orderPageObject.langKey}.user`)]),style:{width:"100%"},"not-found-content":a.productFetching?void 0:null,onSearch:a.fetchProducts,"option-label-prop":"label",onSelect:a.searchValueSelected,disabled:a.editOrderDisable},_e({suffixIcon:C(()=>[j(h)]),default:C(()=>[(S(!0),U(ve,null,me(a.products,d=>(S(),V(o,{key:d.xid,value:d.xid,label:d.name,product:d},{default:C(()=>[L(N(d.name)+" ",1),d.phone&&d.phone!=""?(S(),U("span",we,[v[1]||(v[1]=Y("br",null,null,-1)),L(" "+N(d.phone),1)])):ye("",!0)]),_:2},1032,["value","label","product"]))),128))]),_:2},[a.productFetching?{name:"notFoundContent",fn:C(()=>[j(g,{size:"small"})]),key:"0"}:void 0]),1032,["value","placeholder","not-found-content","onSearch","onSelect","disabled"]),a.orderPageObject.userType=="suppliers"?(S(),V(F,{key:0})):(S(),V(l,{key:1}))])]),_:1},8,["label","help","validateStatus"])}const $e=le(Ae,[["render",Te]]);export{$e as U,De as s};
