import{b as te,Y as ae,z as ne,f as p,g as N,aW as L,b7 as oe,aZ as se,b8 as ue,b6 as ie,_ as le,d as re,aV as de,a6 as ce,aX as pe,r as j,o as S,i as V,w as k,j as z,a as q,ab as _e,c as Y,M as me,G as ve,aY as fe,aD as he,n as xe,l as U,t as M,k as be,aG as ye}from"./app-CLFRnoDY.js";import{S as ge}from"./SupplierAddButton-Dku0QJdv.js";import{C as Se}from"./CustomerAddButton-nrbVJTU8.js";const De=()=>{const{formatAmount:a,orderType:b,orderPageObject:i,selectedWarehouse:A,dayjs:C,appSetting:c}=te(),{t:f}=ae(),g=ne(),s=p([]),v=p([]),F=p([]),l=N({orderSearchTerm:void 0,productFetching:!1,products:[]}),r=p({order_type:g.params.type,invoice_number:"",order_date:C().utc().format("YYYY-MM-DDTHH:mm:ssZ"),warehouse_id:b.value=="stock-transfers"?void 0:A.value.xid,user_id:void 0,terms_condition:A.value.terms_condition,notes:"",order_status:void 0,tax_id:void 0,tax_rate:0,tax_amount:0,discount:0,shipping:0,subtotal:0}),d=p([]),w=p({subtotal:0,tax:0}),$=p(!1),G=p(!1),_=p({}),H=p([]),B=p(""),K=L(e=>{I(e)},300),I=e=>{l.products=[],e!=""&&(l.productFetching=!0,axiosAdmin.post("search-product",{order_type:i.value.type,search_term:e,warehouse_id:r.value.warehouse_id}).then(t=>{t.data.length==1?P("",{product:t.data[0]}):l.products=t.data,l.productFetching=!1}))},Q=e=>{ie(()=>{e.keyCode==13&&I(e.target.value)})},P=(e,n)=>{const t=n.product;if(oe(v.value,t.xid)){const m=se(s.value,["xid",t.xid]);if(m&&m.quantity<m.stock_quantity){const h=[];var o={};s.value.map(x=>{var y=x.quantity;x.xid==t.xid&&(y+=1,x.quantity=y,o=x),h.push(x)}),s.value=h;var u=new Audio(c.value.beep_audio_url);u.play(),l.orderSearchTerm=void 0,l.products=[],D(o)}else l.orderSearchTerm=void 0,l.products=[],ue.error(f("common.out_of_stock"))}else{v.value.push(t.xid),s.value.push({...t,sn:s.value.length+1,unit_price:a(t.unit_price),tax_amount:a(t.tax_amount),subtotal:a(t.subtotal)}),l.orderSearchTerm=void 0,l.products=[],T();var u=new Audio(c.value.beep_audio_url);u.play()}},R=e=>{var n=parseFloat(e.quantity),t=parseFloat(e.stock_quantity);e.item_id;const u=parseFloat(e.unit_price);e.product_type!="service"&&(n=n>t&&(i.value.type=="sales"||i.value.type=="purchase-returns")?t:n);const o=e.discount_rate,m=o>0?o/100*u:0,h=u-m;var O=0,x=h,y=u;return e.tax_rate>0&&(e.tax_type=="inclusive"?(y=h*100/(100+e.tax_rate),O=y*(e.tax_rate/100)):(O=h*(e.tax_rate/100),x=h+O,y=h)),{...e,total_discount:m*n,subtotal:x*n,quantity:n,total_tax:O*n,max_quantity:t,single_unit_price:y}},D=e=>{const n=[];s.value.map(t=>{if(t.xid==e.xid){const u=R(e);n.push(u)}else n.push(t)}),s.value=n,T()},T=()=>{let e=0,n=0;s.value.map(m=>{e+=m.subtotal});const t=r.value.discount!=""?parseFloat(r.value.discount):0,u=r.value.tax_rate!=""?parseFloat(r.value.tax_rate):0;s.value.map(m=>{n+=m.total_tax}),w.value.subtotal=e,w.value.tax=n,e=e-t;const o=e*(u/100);e=e+parseFloat(r.value.shipping),r.value.subtotal=a(e+o),r.value.tax_amount=a(o),r.value.discount=t},W=()=>{let e=0,n=0;s.value.map(t=>{e+=t.subtotal}),s.value.map(t=>{n+=t.total_tax}),w.value.subtotal=e,w.value.tax=n},Z=e=>{const n=[];let t=1;s.value.map(o=>{e.item_id&&e.item_id!=""&&e.item_id!=null&&e.item_id==o.item_id&&o.item_id!=null&&(F.value=[...F.value,o.item_id]),o.xid!=e.xid&&(n.push({...o,sn:t,single_unit_price:a(o.single_unit_price),tax_amount:a(o.tax_amount),subtotal:a(o.subtotal)}),t++)}),s.value=n;const u=v.value.filter(o=>o!=e.xid);v.value=u,T()},X=(e,n)=>{r.value.tax_rate=e==null?0:n.tax.rate,T()},J=e=>{_.value={id:e.xid,discount_rate:e.discount_rate,unit_price:e.unit_price,tax_id:e.x_tax_id,tax_type:e.tax_type==null?void 0:e.tax_type},$.value=!0,B.value=e.name},ee=()=>{const e=s.value.filter(o=>o.xid==_.value.id),n=d.value.filter(o=>o.xid==_.value.tax_id),t=_.value.tax_type!=null?_.value.tax_type:"exclusive",u={...e[0],discount_rate:parseFloat(_.value.discount_rate),unit_price:parseFloat(_.value.unit_price),tax_id:_.value.tax_id,tax_rate:n[0]?n[0].rate:0,tax_type:t};D(u),E()},E=()=>{_.value={},$.value=!1};return{state:l,route:g,orderType:b,orderPageObject:i,selectedProducts:s,selectedProductIds:v,formData:r,productsAmount:w,taxes:d,fetchProducts:K,searchValueSelected:P,recalculateValues:R,quantityChanged:D,recalculateFinalTotal:T,showDeleteConfirm:Z,taxChanged:X,editItem:J,addEditVisible:$,addEditFormData:_,addEditFormSubmitting:G,addEditRules:H,addEditPageTitle:B,onAddEditSubmit:ee,onAddEditClose:E,removedOrderItemsIds:F,calculateProductAmount:W,inputValueChanged:Q}},Ae=re({props:["orderPageObject","rules","usersList","editOrderDisable"],emits:["onSuccess"],components:{SearchOutlined:de,SupplierAddButton:ge,CustomerAddButton:Se},setup(a,{emit:b}){const i=N({orderSearchTerm:[],productFetching:!1,products:[]}),A=L(c=>{if(i.products=[],c!=""){const f=c.trim();i.productFetching=!0;const g=`name lk "${f}%" or (phone lk "${f}%")`;let s=`${a.orderPageObject.userType}?fields=id,xid,name,phone&filters=${encodeURIComponent(g)}`;axiosAdmin.get(s).then(v=>{i.products=v.data,i.productFetching=!1})}},300),C=(c,f)=>{b("onSuccess",c)};return ce(()=>a.usersList,(c,f)=>{i.products=[c],i.orderSearchTerm=c.xid}),{...pe(i),fetchProducts:A,searchValueSelected:C}}}),Fe={style:{display:"flex"}},we={key:0},Te=z("br",null,null,-1);function ke(a,b,i,A,C,c){const f=j("SearchOutlined"),g=fe,s=ye,v=he,F=j("SupplierAddButton"),l=j("CustomerAddButton"),r=xe;return S(),V(r,{label:a.$t(`${a.orderPageObject.langKey}.user`),name:"user_id",help:a.rules.user_id?a.rules.user_id.message:null,validateStatus:a.rules.user_id?"error":null,class:"required"},{default:k(()=>[z("span",Fe,[q(v,{value:a.orderSearchTerm,"onUpdate:value":b[0]||(b[0]=d=>a.orderSearchTerm=d),"show-search":"","filter-option":!1,placeholder:a.$t("common.select_default_text",[a.$t(`${a.orderPageObject.langKey}.user`)]),style:{width:"100%"},"not-found-content":a.productFetching?void 0:null,onSearch:a.fetchProducts,"option-label-prop":"label",onSelect:a.searchValueSelected,disabled:a.editOrderDisable},_e({suffixIcon:k(()=>[q(f)]),default:k(()=>[(S(!0),Y(ve,null,me(a.products,d=>(S(),V(s,{key:d.xid,value:d.xid,label:d.name,product:d},{default:k(()=>[U(M(d.name)+" ",1),d.phone&&d.phone!=""?(S(),Y("span",we,[Te,U(" "+M(d.phone),1)])):be("",!0)]),_:2},1032,["value","label","product"]))),128))]),_:2},[a.productFetching?{name:"notFoundContent",fn:k(()=>[q(g,{size:"small"})]),key:"0"}:void 0]),1032,["value","placeholder","not-found-content","onSearch","onSelect","disabled"]),a.orderPageObject.userType=="suppliers"?(S(),V(F,{key:0})):(S(),V(l,{key:1}))])]),_:1},8,["label","help","validateStatus"])}const je=le(Ae,[["render",ke]]);export{je as U,De as s};
