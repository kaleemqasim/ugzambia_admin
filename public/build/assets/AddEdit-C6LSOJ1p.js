import{a as q}from"./apiAdmin-LURDi7d_.js";import{U as H}from"./UserInfo-DlkHHtmb.js";import{Y as J,z as Z,b as R,f as h,_ as O,d as N,E as j,ak as P,a6 as z,o as y,i as I,w as a,a as t,j as M,c as T,G as V,l as C,t as b,k as B,aM as K,a_ as Q,aL as X,aN as x,bi as ee,J as ae,q as L,h as W,R as te,aT as ne,r as U,M as Y,aD as oe,n as se,I as le,b5 as ue,x as de,bj as me,F as re,B as ie,a0 as pe,ap as _e,aG as ce}from"./app-OkfscRLa.js";import{P as ye}from"./AddButton-HCzi3eMt.js";import{D as fe}from"./DateTimePicker-WGMX0g34.js";import{S as ve}from"./SaveOutlined-B1tRbmbv.js";const ge=()=>{const{t:e}=J(),o=Z(),A=["payment_mode_id","user_id"],{dayjs:F}=R(),w=h(o.meta.paymentType),k=h(o.meta.menuParent),v=h(`payment-${w.value}`),$=h({payment_type:w.value,date:F().format("YYYY-MM-DD"),amount:"",payment_mode_id:void 0,user_id:void 0,notes:""}),g=[{title:e("payments.date"),dataIndex:"date",sorter:!0},{title:e("payments.transaction_number"),dataIndex:"payment_number",sorter:!0},{title:e("payments.user"),dataIndex:"user_id",sorter:!0},{title:e("payments.amount"),dataIndex:"amount",sorter:!0},{title:e("common.action"),dataIndex:"action"}],l=[{key:"payment_number",value:e("payments.transaction_number")}],d=[{title:e("stock.invoice_number"),dataIndex:"invoice_number"},{title:e("common.date"),dataIndex:"date"},{title:e("payments.invoice_amount"),dataIndex:"amount"},{title:e("common.action"),dataIndex:"action"}];return{addEditUrl:v,initData:$,columns:g,filterableColumns:l,hashableColumns:A,settleInvoiceColumns:d,paymentType:w,menuParent:k}},be=N({props:["userId","amount"],setup(e,{emit:o}){const{settleInvoiceColumns:A,paymentType:F}=ge(),{addEditRequestAdmin:w,loading:k,rules:v}=q(),{formatDate:$,disabledDate:g,appSetting:l,formatAmountCurrency:d}=R(),p=h([]),D=h(0),f=h(0);j(()=>{_()});const i=()=>{w({url:e.url,data:e.formData,successMessage:e.successMessage,success:n=>{o("addEditSuccess",n.xid)}})},_=()=>{axiosAdmin.post("user-invoices",{user_id:e.userId,payment_type:F.value}).then(n=>{const u=n.data.invoices;var m=e.amount,r=0;P(u,c=>{c.due_amount<=m?(c.paying_amount=c.due_amount,m=parseFloat(m)-parseFloat(c.due_amount),r=parseFloat(r)+parseFloat(c.due_amount)):c.due_amount>m&&(c.paying_amount=m,r=parseFloat(r)+parseFloat(m),m=0)}),D.value=r,f.value=parseFloat(e.amount)-parseFloat(r),p.value=u})},S=n=>{const u=p.value;var m=0;P(u,c=>{m+=parseFloat(c.paying_amount)}),n.paying_amount>n.due_amount?n.paying_amount=n.due_amount:m>e.amount&&(n.paying_amount=parseFloat(e.amount)-(m-parseFloat(n.paying_amount))),n.paying_amount||(n.paying_amount=0);var r=0;P(u,c=>{r+=parseFloat(c.paying_amount)}),D.value=r,f.value=parseFloat(e.amount)-parseFloat(r)},E=()=>{v.value={},o("closed")};return z(e,(n,u)=>{_()}),{loading:k,rules:v,onClose:E,onSubmit:i,invoices:p,settleInvoiceColumns:A,setteledAmount:D,unUsedAmount:f,inputValueChanged:S,appSetting:l,formatDate:$,disabledDate:g,formatAmountCurrency:d}}}),he={class:"table-responsive"},we=M("br",null,null,-1),$e=M("br",null,null,-1);function De(e,o,A,F,w,k){const v=K,$=Q,g=X,l=x,d=ee,p=ae,D=L,f=W;return y(),I(f,null,{default:a(()=>[t(D,{span:24},{default:a(()=>[M("div",he,[t(p,{columns:e.settleInvoiceColumns,"row-key":i=>i.xid,"data-source":e.invoices,pagination:!1},{bodyCell:a(({column:i,record:_})=>[i.dataIndex==="date"?(y(),T(V,{key:0},[C(b(e.formatDate(_.order_date)),1)],64)):B("",!0),i.dataIndex==="amount"?(y(),T(V,{key:1},[C(b(e.formatAmountCurrency(_.total))+" ",1),we,M("small",null,[t(v,{type:"danger"},{default:a(()=>[C(" ("+b(e.$t("common.pending"))+": "+b(e.formatAmountCurrency(_.due_amount))+") ",1)]),_:2},1024)])],64)):B("",!0),i.dataIndex==="action"?(y(),I($,{key:2,addonBefore:e.appSetting.currency.symbol,value:_.paying_amount,"onUpdate:value":S=>_.paying_amount=S,placeholder:"0",min:0,onBlur:S=>e.inputValueChanged(_)},null,8,["addonBefore","value","onUpdate:value","onBlur"])):B("",!0)]),summary:a(()=>[t(d,{fixed:""},{default:a(()=>[t(l,null,{default:a(()=>[t(g,{"col-span":3},{default:a(()=>[t(v,{strong:""},{default:a(()=>[C(b(e.$t("payments.unused_amount"))+" : ",1)]),_:1}),C(" "+b(e.formatAmountCurrency(e.unUsedAmount?e.unUsedAmount:0)),1)]),_:1}),t(g,{"col-span":2},{default:a(()=>[C(b(e.formatAmountCurrency(e.setteledAmount?e.setteledAmount:0)),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["columns","row-key","data-source"]),$e])]),_:1})]),_:1})}const Ce=O(be,[["render",De]]),Se=N({props:["formData","data","visible","url","addEditType","pageTitle","successMessage"],components:{PlusOutlined:te,LoadingOutlined:ne,SaveOutlined:ve,UserInfo:H,PaymentModeAddButton:ye,SettleInvoices:Ce,DateTimePicker:fe},setup(e,{emit:o}){const{addEditRequestAdmin:A,loading:F,rules:w}=q(),{disabledDate:k,appSetting:v,formatAmountCurrency:$,dayjs:g}=R(),l=h([]),d=h([]),p="customer-suppliers",D="payment-modes?limit=10000",f=h(null),i=h({});j(()=>{const n=axiosAdmin.post(p),u=axiosAdmin.get(D);Promise.all([n,u]).then(([m,r])=>{d.value=m.data,l.value=r.data})});const _=()=>{const n=[];e.addEditType=="add"&&f.value&&f.value.invoices&&P(f.value.invoices,u=>{n.push({order_id:u.xid,amount:u.paying_amount})}),A({url:e.url,data:{...i.value,invoices:n},successMessage:e.successMessage,success:u=>{o("addEditSuccess",u.xid)}})},S=()=>{axiosAdmin.get("payment-modes?limit=10000").then(n=>{l.value=n.data})},E=()=>{w.value={},o("closed")};return z(()=>e.visible,(n,u)=>{n&&(e.addEditType=="add"?i.value={...e.formData,date:g().utc().format("YYYY-MM-DDTHH:mm:ssZ")}:i.value={...e.formData})}),{loading:F,rules:w,onClose:E,onSubmit:_,users:d,paymentModes:l,paymentModeAdded:S,settleInvoiceRef:f,appSetting:v,disabledDate:k,formatAmountCurrency:$,drawerWidth:window.innerWidth<=991?"90%":"45%",newFormData:i}}}),Ae={style:{display:"flex"}},Fe={key:1},ke={key:2};function Ie(e,o,A,F,w,k){const v=U("UserInfo"),$=ce,g=oe,l=se,d=L,p=W,D=le,f=U("DateTimePicker"),i=U("PaymentModeAddButton"),_=ue,S=de,E=me,n=U("SettleInvoices"),u=re,m=U("SaveOutlined"),r=ie,c=pe,G=_e;return y(),I(G,{title:e.pageTitle,width:e.drawerWidth,open:e.visible,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},maskClosable:!1,onClose:e.onClose},{footer:a(()=>[t(c,null,{default:a(()=>[t(r,{key:"submit",type:"primary",loading:e.loading,onClick:e.onSubmit},{icon:a(()=>[t(m)]),default:a(()=>[C(" "+b(e.addEditType=="add"?e.$t("common.create"):e.$t("common.update")),1)]),_:1},8,["loading","onClick"]),t(r,{key:"back",onClick:e.onClose},{default:a(()=>[C(b(e.$t("common.cancel")),1)]),_:1},8,["onClick"])]),_:1})]),default:a(()=>[t(u,{layout:"vertical"},{default:a(()=>[t(p,{gutter:16},{default:a(()=>[t(d,{xs:24,sm:24,md:24,lg:24},{default:a(()=>[t(l,{label:e.$t("payments.user"),name:"user_id",help:e.rules.user_id?e.rules.user_id.message:null,validateStatus:e.rules.user_id?"error":null,class:"required"},{default:a(()=>[t(g,{value:e.newFormData.user_id,"onUpdate:value":o[0]||(o[0]=s=>e.newFormData.user_id=s),placeholder:e.$t("common.select_default_text",[e.$t("payments.user")]),allowClear:!0,"option-label-prop":"label",optionFilterProp:"label","show-search":""},{default:a(()=>[(y(!0),T(V,null,Y(e.users,s=>(y(),I($,{key:s.xid,value:s.xid,label:s.name},{default:a(()=>[t(v,{user:s,size:"small"},null,8,["user"])]),_:2},1032,["value","label"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label","help","validateStatus"])]),_:1})]),_:1}),e.addEditType=="add"?(y(),I(p,{key:0,gutter:16},{default:a(()=>[t(d,{xs:24,sm:24,md:24,lg:24},{default:a(()=>[t(l,{label:e.$t("payments.amount"),name:"amount",help:e.rules.amount?e.rules.amount.message:null,validateStatus:e.rules.amount?"error":null,class:"required"},{default:a(()=>[t(D,{prefix:e.appSetting.currency.symbol,value:e.newFormData.amount,"onUpdate:value":o[1]||(o[1]=s=>e.newFormData.amount=s),placeholder:e.$t("common.placeholder_default_text",[e.$t("payments.amount")])},null,8,["prefix","value","placeholder"])]),_:1},8,["label","help","validateStatus"])]),_:1})]),_:1})):B("",!0),t(p,{gutter:16},{default:a(()=>[t(d,{xs:24,sm:24,md:12,lg:12},{default:a(()=>[t(l,{label:e.$t("payments.date"),name:"date",help:e.rules.date?e.rules.date.message:null,validateStatus:e.rules.date?"error":null,class:"required"},{default:a(()=>[t(f,{dateTime:e.newFormData.date,onDateTimeChanged:o[2]||(o[2]=s=>e.newFormData.date=s)},null,8,["dateTime"])]),_:1},8,["label","help","validateStatus"])]),_:1}),t(d,{xs:24,sm:24,md:12,lg:12},{default:a(()=>[t(l,{label:e.$t("payments.payment_mode"),name:"payment_mode_id",help:e.rules.payment_mode_id?e.rules.payment_mode_id.message:null,validateStatus:e.rules.payment_mode_id?"error":null,class:"required"},{default:a(()=>[M("span",Ae,[t(g,{value:e.newFormData.payment_mode_id,"onUpdate:value":o[3]||(o[3]=s=>e.newFormData.payment_mode_id=s),placeholder:e.$t("common.select_default_text",[e.$t("payments.payment_mode")]),allowClear:!0},{default:a(()=>[(y(!0),T(V,null,Y(e.paymentModes,s=>(y(),I($,{key:s.xid,value:s.xid},{default:a(()=>[C(b(s.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"]),t(i,{onOnAddSuccess:e.paymentModeAdded},null,8,["onOnAddSuccess"])])]),_:1},8,["label","help","validateStatus"])]),_:1})]),_:1}),t(p,{gutter:16},{default:a(()=>[t(d,{xs:24,sm:24,md:24,lg:24},{default:a(()=>[t(l,{label:e.$t("payments.notes"),name:"notes",help:e.rules.notes?e.rules.notes.message:null,validateStatus:e.rules.notes?"error":null},{default:a(()=>[t(_,{value:e.newFormData.notes,"onUpdate:value":o[4]||(o[4]=s=>e.newFormData.notes=s),placeholder:e.$t("common.placeholder_default_text",[e.$t("payments.notes")]),"auto-size":{minRows:2,maxRows:3}},null,8,["value","placeholder"])]),_:1},8,["label","help","validateStatus"])]),_:1})]),_:1}),t(S,{class:"mt-0"}),e.addEditType=="add"?(y(),T("div",Fe,[t(p,{gutter:16},{default:a(()=>[t(d,{xs:24,sm:24,md:24,lg:24},{default:a(()=>[t(l,null,{default:a(()=>[t(E,{type:"warning",strong:""},{default:a(()=>[M("blockquote",null,b(e.$t("payments.settle_invoice_using_payment")),1)]),_:1})]),_:1})]),_:1})]),_:1}),e.newFormData.user_id?(y(),I(n,{key:0,ref:"settleInvoiceRef",userId:e.newFormData.user_id,amount:e.newFormData.amount},null,8,["userId","amount"])):B("",!0)])):(y(),T("div",ke))]),_:1})]),_:1},8,["title","width","open","onClose"])}const Ve=O(Se,[["render",Ie]]);export{Ve as A,ge as f};
